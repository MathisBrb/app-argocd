# Plugins n√©cessaires au support S3 (MinIO)
# Le chart Velero attend une liste "initContainers" pour injecter les plugins.
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v1.9.2
    imagePullPolicy: IfNotPresent
    volumeMounts:
      - mountPath: /target
        name: plugins

# On d√©sactive la cr√©ation de secret par Helm (c'est Vault qui g√®re)
credentials:
  useSecret: false

configuration:
  # Velero utilisera ce BSL pour √©crire les backups dans MinIO (bucket "velero")
  backupStorageLocation:
    - name: default
      provider: aws
      bucket: velero
      default: true
      config:
        region: minio
        s3ForcePathStyle: true
        s3Url: http://minio.velero.svc:9000

  volumeSnapshotLocation:
    - name: default
      provider: aws
      config:
        region: minio

# üëá Configuration Vault (injection du fichier /vault/secrets/cloud)
podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/role: "velero-role"
  vault.hashicorp.com/agent-inject-secret-cloud: "secret/data/velero"
  vault.hashicorp.com/agent-inject-template-cloud: |
    {{- with secret "secret/data/velero" -}}
    {{ .Data.data.cloud }}
    {{- end -}}

env:
  AWS_SHARED_CREDENTIALS_FILE: /vault/secrets/cloud
